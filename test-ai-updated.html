<!DOCTYPE html>
<html>
<head>
    <title>Test Updated AI Logic</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .input { background: #f0f8ff; padding: 10px; margin: 5px 0; }
        .output { background: #f0fff0; padding: 10px; margin: 5px 0; }
        .error { background: #fff0f0; padding: 10px; margin: 5px 0; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #console { background: #000; color: #0f0; padding: 15px; font-family: monospace; height: 400px; overflow-y: auto; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Test Updated AI Logic</h1>
    
    <div class="test-case">
        <h3>Manual Test</h3>
        <input type="text" id="userInput" placeholder="Enter test message..." style="width: 300px; padding: 8px;">
        <button onclick="testSingleInput()">Test AI Response</button>
        <button onclick="resetConversation()">Reset Conversation</button>
    </div>

    <div class="test-case">
        <h3>Predefined Tests</h3>
        <button onclick="testScenario('tonight', 'First message - unclear')">Test: "tonight"</button>
        <button onclick="testScenario('I want to play padel', 'First message - clear')">Test: "I want to play padel"</button>
        <button onclick="testScenario('hi', 'First message - greeting')">Test: "hi"</button>
        <button onclick="testScenario('asdf', 'First message - typo')">Test: "asdf"</button>
        <button onclick="testScenario('Show courts in Senayan', 'Clear request')">Test: "Show courts in Senayan"</button>
    </div>

    <div id="console"></div>

    <script type="module">
        // Mock the AI service for testing
        class MockAIMatchmakingService {
            static conversationHistory = []
            static isInitialized = false

            static async initializeConversation() {
                if (this.isInitialized) return
                this.conversationHistory = []
                this.isInitialized = true
                this.log('ðŸ¤– AI conversation initialized')
            }

            static async processMatchmakingRequest(userInput) {
                await this.initializeConversation()
                
                this.log(`ðŸ”µ USER INPUT: ${userInput}`)
                this.log(`ðŸ¤– CALLING AI API with ${this.conversationHistory.length + 3} messages`)
                
                // Mock AI decision logic based on updated rules
                let aiRequest
                
                if (this.conversationHistory.length === 0) {
                    // First message logic
                    if (userInput.toLowerCase().includes('padel') || userInput.toLowerCase().includes('play') || userInput.toLowerCase().includes('court') || userInput.toLowerCase().includes('player')) {
                        if (userInput.toLowerCase().includes('court') || userInput.toLowerCase().includes('venue')) {
                            aiRequest = { action: 'getAvailableVenues', parameters: { activity: 'padel' } }
                        } else if (userInput.toLowerCase().includes('player')) {
                            aiRequest = { action: 'getAvailablePlayers', parameters: { activity: 'padel' } }
                        } else {
                            aiRequest = { action: 'getPersonalizedRecommendations', parameters: { activity: 'padel' } }
                        }
                    } else if (userInput.length < 3 || userInput.toLowerCase() === 'hi' || userInput.toLowerCase() === 'hello' || userInput === 'tonight') {
                        aiRequest = { action: 'needMoreInfo', parameters: { message: 'What would you like to do? Find courts, players, or organize a game?' } }
                    } else {
                        aiRequest = { action: 'needMoreInfo', parameters: { message: "I didn't understand that. What would you like to do?" } }
                    }
                } else {
                    // Follow-up message logic
                    if (userInput === 'tonight') {
                        aiRequest = { action: 'findMatch', parameters: { activity: 'padel', time: 'tonight' } }
                    } else {
                        aiRequest = { action: 'getPersonalizedRecommendations', parameters: { activity: 'padel' } }
                    }
                }

                const mockResponse = JSON.stringify(aiRequest)
                this.log(`âœ… AI RESPONSE: ${mockResponse}`)

                // Store in conversation history
                this.conversationHistory.push(
                    { role: 'user', parts: [{ text: userInput }] },
                    { role: 'model', parts: [{ text: mockResponse }] }
                )

                return {
                    text: `AI decided: ${aiRequest.action}`,
                    sessionCards: [{ type: 'test', data: aiRequest }],
                    needsMoreInfo: aiRequest.action === 'needMoreInfo'
                }
            }

            static log(message) {
                const console = document.getElementById('console')
                console.innerHTML += message + '\\n'
                console.scrollTop = console.scrollHeight
            }

            static clearLog() {
                document.getElementById('console').innerHTML = ''
            }
        }

        // Make available globally
        window.MockAIMatchmakingService = MockAIMatchmakingService

        window.testSingleInput = async function() {
            const input = document.getElementById('userInput').value
            if (!input.trim()) return
            
            await testScenario(input, 'Manual test')
            document.getElementById('userInput').value = ''
        }

        window.testScenario = async function(input, description) {
            MockAIMatchmakingService.log(`\\nðŸ“‹ ${description}`)
            MockAIMatchmakingService.log(`Input: "${input}"`)
            MockAIMatchmakingService.log('---')
            
            try {
                const response = await MockAIMatchmakingService.processMatchmakingRequest(input)
                MockAIMatchmakingService.log(`Result: ${response.text}`)
                MockAIMatchmakingService.log(`Needs More Info: ${response.needsMoreInfo}`)
            } catch (error) {
                MockAIMatchmakingService.log(`âŒ Error: ${error.message}`)
            }
        }

        window.resetConversation = function() {
            MockAIMatchmakingService.conversationHistory = []
            MockAIMatchmakingService.isInitialized = false
            MockAIMatchmakingService.log('\\nðŸ”„ Conversation reset')
        }

        // Auto-clear console on load
        MockAIMatchmakingService.clearLog()
        MockAIMatchmakingService.log('ðŸ§ª AI Logic Test Ready')
        MockAIMatchmakingService.log('Click buttons to test different scenarios\\n')
    </script>
</body>
</html>